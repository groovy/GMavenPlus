<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractCompileMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GMavenPlus Plugin</a> &gt; <a href="index.source.html" class="el_package">org.codehaus.gmavenplus.mojo</a> &gt; <span class="el_source">AbstractCompileMojo.java</span></div><h1>AbstractCompileMojo.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2011 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.codehaus.gmavenplus.mojo;

import org.apache.maven.plugins.annotations.Parameter;
import org.codehaus.gmavenplus.model.IncludeClasspath;

import java.io.File;

import org.apache.maven.plugins.annotations.Component;
import org.apache.maven.toolchain.Toolchain;
import org.apache.maven.toolchain.ToolchainManager;
import org.codehaus.gmavenplus.model.GroovyCompileConfiguration;
import org.codehaus.gmavenplus.util.ForkedGroovyCompiler;
import org.codehaus.gmavenplus.util.GroovyCompiler;

import java.io.*;
import java.lang.reflect.InvocationTargetException;
import java.net.MalformedURLException;
import java.nio.file.Files;
import java.util.ArrayList;
import java.util.List;
import java.util.Set;


/**
 * The base compile mojo, which all compile mojos extend.
 *
 * @author Keegan Witt
 */
<span class="fc" id="L45">public abstract class AbstractCompileMojo extends AbstractGroovySourcesMojo {</span>

    /**
     * The encoding of source files.
     */
    @Parameter(defaultValue = &quot;${project.build.sourceEncoding}&quot;)
    protected String sourceEncoding;

    /**
     * The Groovy compiler bytecode compatibility. One of
     * &lt;ul&gt;
     *   &lt;li&gt;1.4 (or 4)&lt;/li&gt;
     *   &lt;li&gt;1.5 (or 5)&lt;/li&gt;
     *   &lt;li&gt;1.6 (or 6)&lt;/li&gt;
     *   &lt;li&gt;1.7 (or 7)&lt;/li&gt;
     *   &lt;li&gt;1.8 (or 8)&lt;/li&gt;
     *   &lt;li&gt;9 (or 1.9)&lt;/li&gt;
     *   &lt;li&gt;10&lt;/li&gt;
     *   &lt;li&gt;11&lt;/li&gt;
     *   &lt;li&gt;12&lt;/li&gt;
     *   &lt;li&gt;13&lt;/li&gt;
     *   &lt;li&gt;14&lt;/li&gt;
     *   &lt;li&gt;15&lt;/li&gt;
     *   &lt;li&gt;16&lt;/li&gt;
     *   &lt;li&gt;17&lt;/li&gt;
     *   &lt;li&gt;18&lt;/li&gt;
     *   &lt;li&gt;19&lt;/li&gt;
     *   &lt;li&gt;20&lt;/li&gt;
     *   &lt;li&gt;21&lt;/li&gt;
     *   &lt;li&gt;22&lt;/li&gt;
     *   &lt;li&gt;23&lt;/li&gt;
     *   &lt;li&gt;24&lt;/li&gt;
     *   &lt;li&gt;25&lt;/li&gt;
     * &lt;/ul&gt;
     * Using 1.6 (or 6) or 1.7 (or 7) requires Groovy &amp;gt;= 2.1.3.
     * Using 1.8 (or 8) requires Groovy &amp;gt;= 2.3.3.
     * Using 9 (or 1.9) requires Groovy &amp;gt;= 2.5.3, or Groovy &amp;gt;= 2.6.0 alpha 4, or Groovy &amp;gt;= 3.0.0 alpha 2.
     * Using 9 (or 1.9) with invokedynamic requires Groovy &amp;gt;= 2.5.3, or Groovy &amp;gt;= 3.0.0 alpha 2, but not any 2.6 versions.
     * Using 10, 11, or 12 requires Groovy &amp;gt;= 2.5.3, or Groovy &amp;gt;= 3.0.0 alpha 4, but not any 2.6 versions.
     * Using 13 requires Groovy &amp;gt;= 2.5.7, or Groovy &amp;gt;= 3.0.0-beta-1, but not any 2.6 versions.
     * Using 14 requires Groovy &amp;gt;= 3.0.0 beta-2.
     * Using 15 requires Groovy &amp;gt;= 3.0.3.
     * Using 16 requires Groovy &amp;gt;= 3.0.6.
     * Using 17 requires Groovy &amp;gt;= 3.0.8 or Groovy &amp;gt; 4.0.0-alpha-3.
     * Using 18 requires Groovy &amp;gt; 4.0.0-beta-1.
     * Using 19 requires Groovy &amp;gt; 4.0.2.
     * Using 20 requires Groovy &amp;gt; 4.0.6.
     * Using 21 requires Groovy &amp;gt; 4.0.11.
     * Using 22 requires Groovy &amp;gt; 4.0.16 or Groovy &amp;gt; 5.0.0-alpha-3.
     * Using 23 requires Groovy &amp;gt; 4.0.21 or Groovy &amp;gt; 5.0.0-alpha-8.
     * Using 24 requires Groovy &amp;gt; 4.0.24 or Groovy &amp;gt; 5.0.0-alpha-11.
     * Using 25 requires Groovy &amp;gt; 4.0.27 or Groovy &amp;gt; 5.0.0-alpha-13.
     */
    @Parameter(property = &quot;maven.compiler.target&quot;, defaultValue = &quot;1.8&quot;)
    protected String targetBytecode;

    /**
     * Whether to check that the version of Groovy used is able to use the requested &lt;code&gt;targetBytecode&lt;/code&gt;.
     *
     * @since 1.9.0
     */
    @Parameter(property = &quot;skipBytecodeCheck&quot;, defaultValue = &quot;false&quot;)
    protected boolean skipBytecodeCheck;

    /**
     * Whether Groovy compiler should be set to debug.
     */
    @Parameter(defaultValue = &quot;false&quot;)
    protected boolean debug;

    /**
     * Whether Groovy compiler should be set to verbose.
     */
    @Parameter(defaultValue = &quot;false&quot;)
    protected boolean verbose;

    /**
     * Groovy compiler warning level. Should be one of:
     * &lt;dl&gt;
     *   &lt;dt&gt;0&lt;/dt&gt;
     *     &lt;dd&gt;None&lt;/dd&gt;
     *   &lt;dt&gt;1&lt;/dt&gt;
     *     &lt;dd&gt;Likely Errors&lt;/dd&gt;
     *   &lt;dt&gt;2&lt;/dt&gt;
     *     &lt;dd&gt;Possible Errors&lt;/dd&gt;
     *   &lt;dt&gt;3&lt;/dt&gt;
     *     &lt;dd&gt;Paranoia&lt;/dd&gt;
     * &lt;/dl&gt;
     */
    @Parameter(defaultValue = &quot;1&quot;)
    protected int warningLevel;

    /**
     * Groovy compiler error tolerance (the number of non-fatal errors (per unit) that should be tolerated before compilation is aborted).
     */
    @Parameter(defaultValue = &quot;0&quot;)
    protected int tolerance;

    /**
     * Whether to support invokeDynamic (requires Java 7 or greater and Groovy indy 2.0.0-beta-3 or greater).
     * Has no effect for Groovy 4, as it is always enabled.
     */
    @Parameter(defaultValue = &quot;false&quot;)
    protected boolean invokeDynamic;

    /**
     * Whether to enable Groovy's parallel parsing. Requires Groovy 3.0.5.
     * Is enabled by default for Groovy 4.0.0-alpha-1 or newer.
     *
     * @since 1.11.0
     */
<span class="fc" id="L156">    @Parameter</span>
    protected Boolean parallelParsing = null;

    /**
     * A &lt;a href=&quot;http://groovy-lang.org/dsls.html#compilation-customizers&quot;&gt;script&lt;/a&gt; for tweaking the configuration options
     * (requires Groovy 2.1.0-beta-1 or greater). Note that its encoding must match your source encoding.
     */
    @Parameter
    protected File configScript;

    /**
     * Generate metadata for reflection on method parameter names using the functionality provided by JEP 118
     * (requires Java 8 or greater and Groovy 2.5.0-alpha-1 or greater).
     */
    @Parameter(defaultValue = &quot;false&quot;)
    protected boolean parameters;

    /**
     * What classpath to include. One of
     * &lt;ul&gt;
     *   &lt;li&gt;PROJECT_ONLY&lt;/li&gt;
     *   &lt;li&gt;PROJECT_AND_PLUGIN&lt;/li&gt;
     *   &lt;li&gt;PLUGIN_ONLY&lt;/li&gt;
     * &lt;/ul&gt;
     * Uses the same scope as the required dependency resolution of this mojo. Use only if you know what you're doing.
     *
     * @since 1.8.0
     */
    @Parameter(defaultValue = &quot;PROJECT_ONLY&quot;)
    protected IncludeClasspath includeClasspath;

    /**
     * Whether the bytecode version has preview features enabled (JEP 12).
     * Requires Groovy &amp;gt;= 3.0.0-beta-1 or Groovy &amp;gt;= 2.5.7, but not any 2.6 versions and Java &amp;gt;= 12.
     *
     * @since 1.7.1
     */
    @Parameter(defaultValue = &quot;false&quot;)
    protected boolean previewFeatures;

    /**
     * The ToolchainManager.
     */
    @Component
    protected ToolchainManager toolchainManager;

    /**
     * whether to fork the compilation.
     */
    @Parameter(defaultValue = &quot;false&quot;)
    protected boolean fork;

    /**
     * Performs compilation of compile mojos.
     *
     * @param sources                the sources to compile
     * @param classpath              the classpath to use for compilation
     * @param compileOutputDirectory the directory to write the compiled class files to
     * @throws ClassNotFoundException    when a class needed for compilation cannot be found
     * @throws InstantiationException    when a class needed for compilation cannot be instantiated
     * @throws IllegalAccessException    when a method needed for compilation cannot be accessed
     * @throws InvocationTargetException when a reflection invocation needed for compilation cannot be completed
     * @throws MalformedURLException     when a classpath element provides a malformed URL
     */
    @SuppressWarnings({&quot;rawtypes&quot;})
    protected synchronized void doCompile(final Set&lt;File&gt; sources, final List classpath, final File compileOutputDirectory)
            throws ClassNotFoundException, InstantiationException, IllegalAccessException, InvocationTargetException, MalformedURLException {
<span class="nc" id="L223">        GroovyCompileConfiguration configuration = new GroovyCompileConfiguration(sources, classpath, compileOutputDirectory);</span>
<span class="nc" id="L224">        configuration.setIncludeClasspath(includeClasspath);</span>
<span class="nc" id="L225">        configuration.setSkipBytecodeCheck(skipBytecodeCheck);</span>
<span class="nc" id="L226">        configuration.setDebug(debug);</span>
<span class="nc" id="L227">        configuration.setVerbose(verbose);</span>
<span class="nc" id="L228">        configuration.setWarningLevel(warningLevel);</span>
<span class="nc" id="L229">        configuration.setTolerance(tolerance);</span>
<span class="nc" id="L230">        configuration.setInvokeDynamic(invokeDynamic);</span>
<span class="nc" id="L231">        configuration.setParallelParsing(parallelParsing);</span>
<span class="nc" id="L232">        configuration.setConfigScript(configScript);</span>
<span class="nc" id="L233">        configuration.setParameters(parameters);</span>
<span class="nc" id="L234">        configuration.setPreviewFeatures(previewFeatures);</span>
<span class="nc" id="L235">        configuration.setSourceEncoding(sourceEncoding);</span>
<span class="nc" id="L236">        configuration.setTargetBytecode(targetBytecode);</span>

<span class="nc" id="L238">        Toolchain toolchain = toolchainManager.getToolchainFromBuildContext(&quot;jdk&quot;, session);</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (toolchain != null) {</span>
<span class="nc" id="L240">            getLog().info(&quot;Toolchain in gmavenplus-plugin: &quot; + toolchain);</span>
<span class="nc" id="L241">            performForkedCompilation(configuration, toolchain.findTool(&quot;java&quot;));</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">        } else if (fork) {</span>
<span class="nc" id="L243">            String javaExecutable = getJavaExecutable();</span>
<span class="nc" id="L244">            getLog().info(&quot;Forking compilation using &quot; + javaExecutable);</span>
<span class="nc" id="L245">            performForkedCompilation(configuration, javaExecutable);</span>
<span class="nc" id="L246">        } else {</span>
<span class="nc" id="L247">            performInProcessCompilation(configuration, classpath);</span>
        }
<span class="nc" id="L249">    }</span>

    protected void performInProcessCompilation(GroovyCompileConfiguration configuration, List&lt;?&gt; classpath) throws MalformedURLException, ClassNotFoundException, InvocationTargetException, InstantiationException, IllegalAccessException {
<span class="nc" id="L252">        setupClassWrangler(classpath, includeClasspath);</span>
<span class="nc" id="L253">        logPluginClasspath();</span>
<span class="nc" id="L254">        classWrangler.logGroovyVersion(mojoExecution.getMojoDescriptor().getGoal());</span>

<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (!groovyVersionSupportsAction()) {</span>
<span class="nc" id="L257">            getLog().error(&quot;Your Groovy version (&quot; + classWrangler.getGroovyVersionString() + &quot;) doesn't support compilation. The minimum version of Groovy required is &quot; + minGroovyVersion + &quot;. Skipping compiling.&quot;);</span>
<span class="nc" id="L258">            return;</span>
        }

<span class="nc" id="L261">        GroovyCompiler compiler = new GroovyCompiler(classWrangler, getLog());</span>
<span class="nc" id="L262">        compiler.compile(configuration);</span>
<span class="nc" id="L263">    }</span>

    protected void performForkedCompilation(GroovyCompileConfiguration configuration, String javaExecutable) {
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (javaExecutable == null) {</span>
<span class="nc" id="L267">            getLog().warn(&quot;Unable to find 'java' executable for toolchain. Falling back to in-process compilation.&quot;);</span>
            try {
<span class="nc" id="L269">                performInProcessCompilation(configuration, configuration.getClasspath());</span>
<span class="nc" id="L270">            } catch (Exception e) {</span>
<span class="nc" id="L271">                throw new RuntimeException(&quot;Compilation failed&quot;, e);</span>
<span class="nc" id="L272">            }</span>
<span class="nc" id="L273">            return;</span>
        }

        try {
<span class="nc" id="L277">            File configFile = File.createTempFile(&quot;gmavenplus-compile-config&quot;, &quot;.ser&quot;);</span>
<span class="nc" id="L278">            configFile.deleteOnExit();</span>
<span class="nc" id="L279">            try (ObjectOutputStream oos = new ObjectOutputStream(Files.newOutputStream(configFile.toPath()))) {</span>
<span class="nc" id="L280">                oos.writeObject(configuration);</span>
            }

<span class="nc" id="L283">            List&lt;String&gt; command = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L284">            command.add(javaExecutable);</span>
<span class="nc" id="L285">            command.add(&quot;-cp&quot;);</span>
<span class="nc" id="L286">            command.add(buildForkClasspath());</span>
<span class="nc" id="L287">            command.add(ForkedGroovyCompiler.class.getName());</span>
<span class="nc" id="L288">            command.add(configFile.getAbsolutePath());</span>

<span class="nc" id="L290">            getLog().info(&quot;Forking compilation using &quot; + javaExecutable);</span>
<span class="nc" id="L291">            getLog().debug(&quot;Command: &quot; + command);</span>

<span class="nc" id="L293">            ProcessBuilder pb = new ProcessBuilder(command);</span>
<span class="nc" id="L294">            pb.inheritIO();</span>
<span class="nc" id="L295">            Process process = pb.start();</span>
<span class="nc" id="L296">            int exitCode = process.waitFor();</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">            if (exitCode != 0) {</span>
<span class="nc" id="L298">                throw new RuntimeException(&quot;Groovy compilation failed with exit code &quot; + exitCode);</span>
            }
<span class="nc" id="L300">        } catch (IOException | InterruptedException e) {</span>
<span class="nc" id="L301">            throw new RuntimeException(&quot;Unable to fork compilation&quot;, e);</span>
<span class="nc" id="L302">        }</span>
<span class="nc" id="L303">    }</span>

    protected String buildForkClasspath() {
<span class="nc" id="L306">        StringBuilder cp = new StringBuilder();</span>
        // Add plugin artifact
<span class="nc" id="L308">        cp.append(pluginDescriptor.getPluginArtifact().getFile().getAbsolutePath());</span>

        // Add plugin dependencies
<span class="nc bnc" id="L311" title="All 2 branches missed.">        for (org.apache.maven.artifact.Artifact artifact : pluginDescriptor.getArtifacts()) {</span>
<span class="nc" id="L312">            cp.append(File.pathSeparator);</span>
<span class="nc" id="L313">            cp.append(artifact.getFile().getAbsolutePath());</span>
<span class="nc" id="L314">        }</span>

        // Add maven-plugin-api jar which is 'provided' so not in getArtifacts()
        try {
<span class="nc" id="L318">            Class&lt;?&gt; logClass = org.apache.maven.plugin.logging.Log.class;</span>
<span class="nc" id="L319">            java.security.CodeSource codeSource = logClass.getProtectionDomain().getCodeSource();</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            if (codeSource != null) {</span>
<span class="nc" id="L321">                String logJar = new File(codeSource.getLocation().toURI()).getAbsolutePath();</span>
<span class="nc" id="L322">                cp.append(File.pathSeparator).append(logJar);</span>
            }
<span class="nc" id="L324">        } catch (Exception e) {</span>
<span class="nc" id="L325">            getLog().warn(&quot;Could not find maven-plugin-api jar to add to fork classpath&quot;, e);</span>
<span class="nc" id="L326">        }</span>

<span class="nc" id="L328">        return cp.toString();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>